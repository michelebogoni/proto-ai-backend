<style>
  .proto-ai-widget {
    width: 100%;
    height: 100%;
    min-height: 500px;
    display: flex;
    flex-direction: column;
    background: #F8FAFC;
    font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #111827;
    border-radius: 20px;
    overflow: hidden;
    box-sizing: border-box;
    border: 1px solid #E2E8F0;
  }

  .proto-ai-widget *, .proto-ai-widget *::before, .proto-ai-widget *::after {
    box-sizing: border-box;
  }

  .proto-ai-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scrollbar-width: none;
  }

  .proto-ai-messages::-webkit-scrollbar {
    display: none;
  }

  .proto-ai-msg {
    display: flex;
    gap: 10px;
    max-width: 85%;
    animation: proto-ai-fade 0.3s ease;
  }

  @keyframes proto-ai-fade {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .proto-ai-msg--user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .proto-ai-msg--assistant {
    align-self: flex-start;
  }

  .proto-ai-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 2px;
    overflow: hidden;
    background: #F1F5F9;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .proto-ai-avatar img {
    width: 36px !important;
    height: 36px !important;
    max-width: 36px !important;
    min-width: 36px !important;
    object-fit: cover !important;
    border-radius: 50% !important;
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .proto-ai-msg--user .proto-ai-avatar {
    display: none;
  }

  .proto-ai-msg-content {
    display: flex;
    flex-direction: column;
  }

  .proto-ai-msg-label {
    font-family: 'DM Mono', 'SF Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 1px;
    margin-bottom: 4px;
    color: #3B82F6;
  }

  .proto-ai-msg--user .proto-ai-msg-label {
    display: none;
  }

  .proto-ai-bubble {
    padding: 14px 18px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: 14px;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .proto-ai-msg--assistant .proto-ai-bubble {
    background: #FFFFFF;
    border: 1px solid #E2E8F0;
    color: #334155;
    border-bottom-left-radius: 4px;
  }

  .proto-ai-msg--user .proto-ai-bubble {
    background: #3B82F6;
    color: #FFFFFF;
    border-bottom-right-radius: 4px;
  }

  .proto-ai-input-bar {
    display: flex;
    gap: 10px;
    padding: 16px 20px;
    background: #FFFFFF;
    border-top: 1px solid #E2E8F0;
  }

  .proto-ai-input {
    flex: 1;
    background: #FFFFFF;
    border: 1.5px solid #E2E8F0;
    border-radius: 12px;
    padding: 14px 16px;
    color: #0A0F1C;
    font-size: 15px;
    font-family: inherit;
    outline: none;
    resize: none;
    min-height: 48px;
    max-height: 120px;
    line-height: 1.4;
    transition: all 0.2s;
  }

  .proto-ai-input::placeholder {
    color: #CBD5E1;
  }

  .proto-ai-input:focus {
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .proto-ai-send {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: #3B82F6;
    border: none;
    color: #FFFFFF;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
  }

  .proto-ai-send:hover:not(:disabled) {
    background: #2563EB;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
  }

  .proto-ai-send:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
</style>

<div class="proto-ai-widget">
  <div class="proto-ai-messages" id="protoAiMessages"></div>
  <div class="proto-ai-input-bar">
    <textarea
      class="proto-ai-input"
      id="protoAiInput"
      placeholder="Scrivi un messaggio..."
      rows="1"
    ></textarea>
    <button class="proto-ai-send" id="protoAiSend" aria-label="Invia">&#10148;</button>
  </div>
</div>

<script>
(function() {
  var API_BASE = "https://europe-west1-proto-ai-8f205.cloudfunctions.net";
  var WELCOME_MSG = "Ciao! Sono Spark. Raccontami cosa vorresti realizzare e ti dico subito se \u00e8 fattibile e quanto potrebbe costare.";
  var LEAD_START = "|||LEAD_DATA|||";
  var LEAD_END = "|||END_LEAD|||";
  var SPARK_AVATAR = "data:image/png;base64,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";

  var sessionId = crypto.randomUUID ? crypto.randomUUID() : ("s-" + Math.random().toString(36).slice(2) + Date.now().toString(36));
  var history = [];
  var isStreaming = false;
  var leadSent = false;

  var messagesEl = document.getElementById("protoAiMessages");
  var inputEl = document.getElementById("protoAiInput");
  var sendBtn = document.getElementById("protoAiSend");

  function addMessage(role, text) {
    var wrapper = document.createElement("div");
    wrapper.className = "proto-ai-msg proto-ai-msg--" + role;

    var avatar = document.createElement("div");
    avatar.className = "proto-ai-avatar";
    if (role === "assistant") {
      var img = document.createElement("img");
      img.src = SPARK_AVATAR;
      img.alt = "Spark";
      avatar.appendChild(img);
    }

    var content = document.createElement("div");
    content.className = "proto-ai-msg-content";

    var label = document.createElement("div");
    label.className = "proto-ai-msg-label";
    label.textContent = role === "assistant" ? "SPARK" : "";

    var bubble = document.createElement("div");
    bubble.className = "proto-ai-bubble";
    bubble.textContent = text;

    content.appendChild(label);
    content.appendChild(bubble);
    wrapper.appendChild(avatar);
    wrapper.appendChild(content);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    return bubble;
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  inputEl.addEventListener("input", function() {
    inputEl.style.height = "auto";
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
  });

  inputEl.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener("click", function() {
    sendMessage();
  });

  function sendMessage() {
    var text = inputEl.value.trim();
    if (!text || isStreaming) return;

    addMessage("user", text);
    history.push({ role: "user", content: text });

    inputEl.value = "";
    inputEl.style.height = "auto";
    setStreaming(true);

    var assistantBubble = addMessage("assistant", "");
    var fullResponse = "";

    fetch(API_BASE + "/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId: sessionId, message: text, history: history.slice(0, -1) })
    }).then(function(response) {
      if (!response.ok) throw new Error("HTTP " + response.status);

      var reader = response.body.getReader();
      var decoder = new TextDecoder();
      var buffer = "";

      function read() {
        return reader.read().then(function(result) {
          if (result.done) {
            finishStream(fullResponse);
            return;
          }

          buffer += decoder.decode(result.value, { stream: true });
          var lines = buffer.split("\n");
          buffer = lines.pop() || "";

          for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (!line.startsWith("data: ")) continue;

            try {
              var data = JSON.parse(line.slice(6));
              if (data.type === "text") {
                fullResponse += data.content;
                var displayText = fullResponse;
                var markerIdx = displayText.indexOf(LEAD_START);
                if (markerIdx !== -1) {
                  displayText = displayText.substring(0, markerIdx);
                } else {
                  // Hide partial marker fragments at the end (e.g. "|||" or "|||LEAD")
                  for (var k = Math.min(LEAD_START.length - 1, displayText.length); k > 0; k--) {
                    if (displayText.endsWith(LEAD_START.substring(0, k))) {
                      displayText = displayText.substring(0, displayText.length - k);
                      break;
                    }
                  }
                }
                assistantBubble.textContent = displayText.trimEnd();
                scrollToBottom();
              } else if (data.type === "done") {
                finishStream(fullResponse);
                return;
              } else if (data.type === "error") {
                assistantBubble.textContent = data.content || "Si \u00e8 verificato un errore.";
                setStreaming(false);
                return;
              }
            } catch (e) { /* skip malformed SSE */ }
          }

          return read();
        });
      }

      return read();
    }).catch(function(err) {
      assistantBubble.textContent = "Si \u00e8 verificato un errore di connessione. Riprova tra qualche istante.";
      setStreaming(false);
    });
  }

  function finishStream(responseText) {
    var cleanText = responseText;
    var startIdx = responseText.indexOf(LEAD_START);
    var endIdx = responseText.indexOf(LEAD_END);

    if (startIdx !== -1 && endIdx !== -1) {
      var jsonStr = responseText.substring(startIdx + LEAD_START.length, endIdx);
      cleanText = responseText.substring(0, startIdx).trimEnd();

      if (!leadSent) {
        try {
          var leadData = JSON.parse(jsonStr);
          if (leadData.telefono && leadData.descrizioneProgetto) {
            leadSent = true;
            fetch(API_BASE + "/lead", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                nome: leadData.nome || "",
                email: leadData.email || "",
                telefono: leadData.telefono,
                nomeAzienda: leadData.nomeAzienda || "",
                descrizioneProgetto: leadData.descrizioneProgetto,
                preventivoIndicato: leadData.preventivoIndicato || "",
                probabilitaChiusura: leadData.probabilitaChiusura || 0,
                noteQualifica: leadData.noteQualifica || "",
                conversazione: history.concat([{ role: "assistant", content: cleanText }])
              })
            }).catch(function() { /* silenzioso */ });
          }
        } catch (e) { /* JSON non valido, ignora */ }
      }
    }

    if (cleanText) {
      history.push({ role: "assistant", content: cleanText });
    }

    // Update bubble with clean text (no marker)
    var bubbles = messagesEl.querySelectorAll(".proto-ai-msg--assistant .proto-ai-bubble");
    if (bubbles.length > 0) {
      bubbles[bubbles.length - 1].textContent = cleanText;
    }

    setStreaming(false);
  }

  function setStreaming(val) {
    isStreaming = val;
    sendBtn.disabled = val;
    inputEl.disabled = val;
    if (!val) inputEl.focus();
  }

  addMessage("assistant", WELCOME_MSG);
})();
</script>
